{
  "$schema": "https://json-schema.org/draft-07/schema#",
  "version": "1.0.0",
  "description": "Pre-Work Validation Hook Configuration - Enforces HtmlGraph workflow before code changes",

  "core_principles": {
    "sdk_only": "SDK is the ONLY interface to .htmlgraph/ - never direct Write/Edit",
    "spike_planning": "Spikes are for planning and creating work items (via SDK only)",
    "implementation_work": "Features/bugs/chores are for code implementation"
  },

  "always_allow": {
    "description": "Read-only tools are always allowed without work items",
    "tools": ["Read", "Glob", "Grep", "LSP", "Skill", "Task", "TaskOutput", "AskUserQuestion"],
    "bash_patterns": [
      "^git status",
      "^git diff",
      "^git log",
      "^uv run htmlgraph status",
      "^uv run htmlgraph session",
      "^uv run python.*-c",
      "^ls",
      "^pwd",
      "^cat",
      "^head",
      "^tail",
      "^find",
      "^grep"
    ]
  },

  "always_deny": {
    "description": "Operations that are NEVER allowed (even with active work)",
    "direct_htmlgraph_writes": {
      "tools": ["Write", "Edit", "Delete", "NotebookEdit"],
      "path_patterns": ["\\.htmlgraph/"],
      "message": "Never write directly to .htmlgraph/. Use SDK: uv run htmlgraph feature create/start/complete",
      "suggestion": "Use SDK commands:\n  uv run htmlgraph feature create 'Title'\n  uv run htmlgraph feature start <id>\n  uv run htmlgraph bug create 'Title'"
    }
  },

  "sdk_commands": {
    "description": "Bash commands that invoke HtmlGraph SDK",
    "patterns": [
      "^uv run htmlgraph ",
      "^htmlgraph "
    ],
    "allowed_during_spike": true,
    "examples": [
      "uv run htmlgraph feature create 'Add validation'",
      "uv run htmlgraph bug create 'Fix drift issue'",
      "uv run htmlgraph feature start feat-123"
    ]
  },

  "work_type_rules": {
    "spike": {
      "description": "Spikes (auto or manual) are for planning and creating work items via SDK",
      "allow": {
        "read_operations": ["Read", "Glob", "Grep", "LSP"],
        "sdk_commands": ["Bash matching sdk_commands.patterns"]
      },
      "deny": {
        "direct_writes": ["Write", "Edit", "Delete", "NotebookEdit"],
        "code_bash": ["Bash that modifies code (npm, git commit, uv build, etc.)"]
      },
      "deny_message": "Spike '{spike_id}' is for planning only.\n\nAllowed:\n  - Read operations (Read, Grep, Glob)\n  - SDK commands (uv run htmlgraph feature create)\n\nFor code changes:\n  1. Create feature: uv run htmlgraph feature create 'Title'\n  2. Start feature: uv run htmlgraph feature start <id>\n  3. Then make code changes"
    },
    "implementation": {
      "description": "Features, bugs, chores allow all code operations (except direct .htmlgraph/ writes)",
      "types": ["feature", "bug", "chore"],
      "allow": {
        "code_operations": ["Write", "Edit", "Delete", "NotebookEdit (not .htmlgraph/)"],
        "code_bash": ["All Bash commands"],
        "sdk_commands": ["All SDK commands"]
      },
      "deny": {
        "direct_htmlgraph_writes": ["Write/Edit/Delete to .htmlgraph/ paths"]
      }
    }
  },

  "code_operations": {
    "description": "Tools and bash commands that modify code",
    "tools": ["Write", "Edit", "Delete", "NotebookEdit"],
    "bash_patterns": [
      "^npm install",
      "^npm run",
      "^yarn install",
      "^yarn add",
      "^git commit",
      "^git push",
      "^uv build",
      "^uv publish",
      "^pip install(?! htmlgraph)",
      "^python setup.py"
    ]
  },

  "permission_responses": {
    "description": "Standard JSON responses for permission decisions",
    "templates": {
      "read_only_allowed": {
        "decision": "allow",
        "reason": "Read-only operation"
      },
      "sdk_command_with_spike": {
        "decision": "allow",
        "reason": "Planning with spike {spike_id}: creating work items via SDK"
      },
      "sdk_command_no_work": {
        "decision": "allow",
        "reason": "Creating work item via SDK"
      },
      "implementation_work_active": {
        "decision": "allow",
        "reason": "Active implementation work: {work_item_id}"
      },
      "no_work_item_code_change": {
        "decision": "deny",
        "reason": "INSTRUCTION: Before this file operation, create and start a work item using the SDK. Execute:\n\nfrom htmlgraph import SDK\nsdk = SDK()\nfeature = sdk.features.create('Your feature description here')\nsdk.features.start(feature.id)\n\nThen retry the file operation.",
        "suggestion": "Work item required for code changes"
      },
      "spike_code_change_denied": {
        "decision": "deny",
        "reason": "INSTRUCTION: Spike '{spike_id}' is for planning only. Before this file operation, create an implementation work item. Execute:\n\nfrom htmlgraph import SDK\nsdk = SDK()\nfeature = sdk.features.create('Implement [describe the change]')\nsdk.features.start(feature.id)\n\nThen retry the file operation.",
        "suggestion": "Implementation work item required"
      },
      "direct_htmlgraph_write_denied": {
        "decision": "deny",
        "reason": "INSTRUCTION: Never write directly to .htmlgraph/ files. Use the SDK instead. For tracking operations, use:\n\nfrom htmlgraph import SDK\nsdk = SDK()\n# Use SDK methods like sdk.features.create(), sdk.sessions.start(), etc.\n\nThe SDK is the only interface to .htmlgraph/ data.",
        "suggestion": "Use SDK - never direct file writes to .htmlgraph/"
      }
    }
  },

  "validation_workflow": {
    "description": "Steps for validating tool calls before execution",
    "steps": [
      {
        "step": 1,
        "action": "check_always_allow",
        "description": "Check if tool is always allowed (Read, Glob, Grep, LSP, read-only Bash)"
      },
      {
        "step": 2,
        "action": "check_always_deny",
        "description": "Check if direct write to .htmlgraph/ (always denied)"
      },
      {
        "step": 3,
        "action": "classify_operation",
        "description": "Classify as: SDK command, code operation, or other"
      },
      {
        "step": 4,
        "action": "get_active_work_item",
        "description": "Query for active work item (in-progress status)"
      },
      {
        "step": 5,
        "action": "apply_work_type_rules",
        "description": "Apply rules based on active work type (spike vs implementation)"
      },
      {
        "step": 6,
        "action": "return_permission",
        "description": "Return JSON decision (deny/allow)"
      }
    ]
  },

  "logging": {
    "enabled": true,
    "log_file": ".htmlgraph/validation-audit.log",
    "log_denials": true,
    "log_bypasses": true,
    "log_permissions": false
  }
}
