<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="htmlgraph-version" content="1.0">
    <title>Design: Agent Delegation & Worktree System</title>
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
    <article id="spk-0478cb84"
             data-type="spike"
             data-status="todo"
             data-priority="medium"
             data-created="2026-01-02T18:54:12.652385"
             data-updated="2026-01-02T18:54:12.652390" data-spike-type="architectural" data-timebox-hours="2">

        <header>
            <h1>Design: Agent Delegation & Worktree System</h1>
            <div class="metadata">
                <span class="badge status-todo">Todo</span>
                <span class="badge priority-medium">Medium Priority</span>
            </div>
        </header>

    
        <section data-spike-metadata>
            <h3>Spike Metadata</h3>
            <dl>
                <dt>Type</dt>
                <dd>Architectural</dd>
                <dt>Timebox</dt>
                <dd>2 hours</dd>
            </dl>
        </section>
        <section data-findings>
            <h3>Findings</h3>
            <div class="findings-content">
                
# Design: Agent Delegation & Parallel Execution

## Problem Statement

HtmlGraph needs better multi-agent coordination:
- Agents can't easily delegate work to each other
- No isolation for parallel work (git conflicts)
- Result sharing is manual (need to know spike IDs)
- No standard patterns for orchestration

## Solution: Delegation System + Git Worktrees

### 1. Delegation API

**Core Methods:**
```python
# Delegate work to another agent
delegation = sdk.delegate_to(
    agent='gemini',
    work_item='feat-123',  # or create new
    instructions='Analyze dependencies',
    worktree=True  # Create isolated git worktree
)

# Check delegation status
status = sdk.check_delegation(delegation.id)

# Retrieve results
results = sdk.get_delegation_results(delegation.id)
```

### 2. Git Worktree Integration

**Auto-create isolated workspaces:**
```bash
# For feat-123 delegated to gemini:
git worktree add .worktrees/gemini-feat-123 -b gemini/feat-123

# Agent works in isolation:
cd .worktrees/gemini-feat-123
# Make changes, commit, push

# When done, merge back:
git checkout main
git merge gemini/feat-123
git worktree remove .worktrees/gemini-feat-123
```

### 3. Result Sharing via Spikes

**Standard pattern:**
- Delegator creates work item + delegation spike
- Delegatee reads delegation spike for instructions
- Delegatee updates delegation spike with findings
- Delegator reads findings and continues

### 4. Parallel Execution Patterns

**Helper for spawning parallel work:**
```python
# Spawn 3 parallel tasks
parallel = sdk.spawn_parallel([
    ('feat-1', 'gemini', 'Analyze deps'),
    ('feat-2', 'codex', 'Research patterns'),
    ('feat-3', 'claude', 'Implement API')
], worktrees=True)

# Wait for all to complete
results = sdk.wait_for_parallel(parallel)
```

### 5. Conflict Detection

**Check before delegating:**
```python
# Check if agents might conflict
conflicts = sdk.check_conflicts([
    ('feat-1', 'gemini'),
    ('feat-2', 'codex')
])

if conflicts:
    print('Warning: Both agents will modify auth.py')
```

## Implementation Plan

### Phase 1: Basic Delegation
- Create Delegation model (Pydantic)
- Add delegation spike creation
- Add result retrieval methods

### Phase 2: Worktree Support
- Add git worktree creation helper
- Add worktree cleanup
- Handle worktree merging

### Phase 3: Parallel Patterns
- Add spawn_parallel helper
- Add conflict detection
- Add wait/aggregate helpers

### Phase 4: CLI Integration
- Add htmlgraph delegate command
- Add htmlgraph worktree commands
- Add status visualization

            </div>
        </section>
        <section data-decision>
            <h3>Decision</h3>
            <p>
Start with Phase 1 (Basic Delegation API) to establish the pattern.
Then add worktree support (Phase 2) for isolation.
Finally add parallel helpers (Phase 3-4).
</p>
        </section>
    </article>
</body>
</html>
