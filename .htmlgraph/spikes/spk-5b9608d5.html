<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="htmlgraph-version" content="1.0">
    <title>Deployment script plugin hook update investigation</title>
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
    <article id="spk-5b9608d5"
             data-type="spike"
             data-status="todo"
             data-priority="medium"
             data-created="2026-01-01T23:23:02.618248"
             data-updated="2026-01-01T23:23:02.618252" data-spike-type="general" data-timebox-hours="4">

        <header>
            <h1>Deployment script plugin hook update investigation</h1>
            <div class="metadata">
                <span class="badge status-todo">Todo</span>
                <span class="badge priority-medium">Medium Priority</span>
            </div>
        </header>

    
        <section data-spike-metadata>
            <h3>Spike Metadata</h3>
            <dl>
                <dt>Type</dt>
                <dd>General</dd>
                <dt>Timebox</dt>
                <dd>4 hours</dd>
            </dl>
        </section>
        <section data-findings>
            <h3>Findings</h3>
            <div class="findings-content">
                
## Investigation Summary

**Finding**: The deployment script IS working correctly. Plugin hooks are being updated properly during deployment.

**Root Cause**: Misunderstanding of Claude Code plugin caching behavior. Old cached versions are SUPPOSED to remain for rollback/debugging.

## Evidence

### 1. All Three Plugin Locations Are In Sync (v0.20.7)

MD5 Checksums - All Identical:
```
7a4ed74e69d79092595fc3d17d6cb667  packages/claude-plugin/hooks/scripts/session-start.py
7a4ed74e69d79092595fc3d17d6cb667  ~/.claude/plugins/cache/local-marketplace/htmlgraph/0.20.7/hooks/scripts/session-start.py
7a4ed74e69d79092595fc3d17d6cb667  ~/.claude/plugins/cache/htmlgraph/htmlgraph/0.20.7/hooks/scripts/session-start.py
```

### 2. Tracker Activation Has Been Removed

No tracker activation in current version (0.20.7):
```bash
grep -c "htmlgraph-tracker" packages/claude-plugin/hooks/scripts/session-start.py
# Output: 0 ✅
```

### 3. Old Cached Versions Still Have Tracker (Expected Behavior)

Versions 0.20.2-0.20.6 still have tracker activation code - **THIS IS CORRECT**

Claude Code keeps historical versions for:
- Rollback capability
- Debugging purposes  
- Version comparison

## Deployment Flow (Working Correctly)

```
Step 1: Git Push
  packages/claude-plugin/ → GitHub
  ↓
Step 5: Plugin Update
  1. claude plugin marketplace update htmlgraph
     → Updates local marketplace cache from GitHub
     → ~/.claude/plugins/cache/local-marketplace/htmlgraph/VERSION/
  ↓
  2. claude plugin update htmlgraph@htmlgraph
     → Updates plugin cache from marketplace
     → ~/.claude/plugins/cache/htmlgraph/htmlgraph/VERSION/
```

## What Actually Happens

1. **Source**: `packages/claude-plugin/hooks/scripts/session-start.py` (no tracker)
2. **Git Push**: Pushes to GitHub
3. **Marketplace Update**: Pulls from GitHub → local marketplace cache
4. **Plugin Update**: Copies from marketplace → plugin cache
5. **Result**: Latest version (0.20.7) has correct hooks ✅

## Verification Commands

```bash
# Check current version
ls -lt ~/.claude/plugins/cache/htmlgraph/htmlgraph/ | head -1
# → 0.20.7 (most recent)

# Verify hooks match source
md5sum packages/claude-plugin/hooks/scripts/session-start.py        ~/.claude/plugins/cache/htmlgraph/htmlgraph/0.20.7/hooks/scripts/session-start.py
# → Same checksum ✅

# Check tracker activation removed
grep "htmlgraph-tracker" ~/.claude/plugins/cache/htmlgraph/htmlgraph/0.20.7/hooks/scripts/session-start.py
# → No output ✅
```

## Conclusion

**STATUS**: ✅ NO CHANGES NEEDED

The deployment script (`scripts/deploy-all.sh`) is working correctly:
- ✅ Git push happens (Step 1)
- ✅ Plugin marketplace update happens (Step 5)
- ✅ Plugin update happens (Step 5)  
- ✅ Latest version has correct hooks
- ✅ Old versions preserved for history (expected behavior)

## Recommendation

Add documentation to explain this behavior:

**For `.claude/rules/deployment.md`:**
```markdown
## Plugin Version Caching

Claude Code maintains multiple plugin versions in cache:
- Latest version: Used by Claude Code
- Historical versions: Kept for rollback/debugging
- Location: ~/.claude/plugins/cache/MARKETPLACE/PLUGIN/VERSION/

**This is expected behavior** - old versions remain in cache.
Deployment updates the LATEST version correctly.
```

## Learning

The "bug" was actually correct behavior. Always verify assumptions by:
1. Checking all plugin locations
2. Comparing checksums 
3. Understanding the plugin update flow
4. Distinguishing current version from historical cache

            </div>
        </section>
    </article>
</body>
</html>
