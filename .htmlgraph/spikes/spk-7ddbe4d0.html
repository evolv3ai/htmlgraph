<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="htmlgraph-version" content="1.0">
    <title>Copilot & OpenCode CLI - Test Results</title>
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
    <article id="spk-7ddbe4d0"
             data-type="spike"
             data-status="todo"
             data-priority="medium"
             data-created="2026-01-02T19:46:52.394013"
             data-updated="2026-01-02T19:46:52.394016" data-spike-type="technical" data-timebox-hours="4">

        <header>
            <h1>Copilot & OpenCode CLI - Test Results</h1>
            <div class="metadata">
                <span class="badge status-todo">Todo</span>
                <span class="badge priority-medium">Medium Priority</span>
            </div>
        </header>

    
        <section data-spike-metadata>
            <h3>Spike Metadata</h3>
            <dl>
                <dt>Type</dt>
                <dd>Technical</dd>
                <dt>Timebox</dt>
                <dd>4 hours</dd>
            </dl>
        </section>
        <section data-findings>
            <h3>Findings</h3>
            <div class="findings-content">
                
# Copilot & OpenCode CLI Headless Mode Test Results

## ✅ GitHub Copilot CLI - PRODUCTION READY

### Installation
- **Version**: 0.0.351 (Commit: 90770bc)
- **Location**: /Users/shakes/.nvm/versions/node/v22.20.0/bin/copilot
- **Status**: Installed and working

### Command Pattern
```bash
copilot -p "prompt" --allow-tool 'shell(command)'
```

### TEST 1: Basic Prompt
**Command:**
```bash
copilot -p "What is 2+2? Brief answer only." --allow-tool 'shell(echo)'
```

**Output:**
```
4

Total usage est:       1 Premium request
Total duration (API):  1.7s
Total duration (wall): 3.3s
Total code changes:    0 lines added, 0 lines removed
Usage by model:
    claude-haiku-4.5     25.8k input, 5 output, 0 cache read, 0 cache write (Est. 1 Premium request)
```

**Key Findings:**
- Uses **Claude Haiku 4.5** (not GPT!)
- Plain text output (no JSON mode found)
- Shows usage statistics (tokens, duration, cost estimate)
- Clean, parseable output

### TEST 2: Git Command Execution
**Command:**
```bash
copilot -p "Show me the last 3 git commits. Just list the commit messages." --allow-tool 'shell(git)'
```

**Output:**
```
✓ Get last 3 commit messages
   $ git --no-pager log --oneline -3
   ↪ 4 lines...

The last 3 commits:

1. `fix: correct deployment script syntax error`
2. `fix: clean up npm package structure`
3. `feat: create npm package for OpenCode extension`

[usage stats...]
```

**Behavior:**
- Executes shell commands (like Codex)
- Shows command execution with ✓ checkmarks
- Formats output nicely
- Provides detailed usage stats

### Output Format Analysis

**Structure:**
1. Response text (at top)
2. Blank line
3. Usage statistics block:
   - Total usage estimate
   - API duration
   - Wall duration
   - Code changes
   - Model-specific token usage

**Parsing Strategy:**
```python
def parse_copilot_output(output: str) -> tuple[str, dict]:
    """Parse Copilot CLI output."""
    lines = output.split('
')
    
    # Find where stats start (usually "Total usage est:")
    stats_start = next(i for i, line in enumerate(lines) if 'Total usage est' in line)
    
    # Response is everything before stats
    response = '
'.join(lines[:stats_start]).strip()
    
    # Parse stats (tokens, duration, etc.)
    stats = {}
    # ... parse usage stats
    
    return response, stats
```

### Copilot vs Other AIs

| Feature | Gemini | Codex | Copilot |
|---------|--------|-------|---------|
| **Output** | JSON | JSONL | Plain text |
| **Model** | Gemini 2.0 Flash | GPT-5.2-Codex | Claude Haiku 4.5 |
| **Agent Type** | Pure LLM | Agentic | Agentic |
| **Command** | `gemini -p "..." --output-format json` | `codex exec --json "..."` | `copilot -p "..." --allow-tool '...'` |
| **Tokens** | JSON stats | JSONL events | Text block |
| **Tool Approval** | N/A | `--approval never` | `--allow-tool 'shell(cmd)'` |

### HeadlessSpawner Integration

**Recommended Implementation:**

```python
def spawn_copilot(
    self,
    prompt: str,
    allow_tools: list[str] | None = None,
    timeout: int = 120
) -> AIResult:
    """Spawn Copilot in headless mode."""
    cmd = ["copilot", "-p", prompt]
    
    # Add tool permissions
    if allow_tools:
        for tool in allow_tools:
            cmd.extend(["--allow-tool", tool])
    
    result = subprocess.run(
        cmd,
        capture_output=True,
        text=True,
        timeout=timeout
    )
    
    # Parse output (response before stats block)
    lines = result.stdout.split('
')
    stats_start = next(
        (i for i, line in enumerate(lines) if 'Total usage est' in line),
        len(lines)
    )
    
    response = '
'.join(lines[:stats_start]).strip()
    
    # Extract token usage from stats
    # (requires parsing the usage stats text)
    tokens = None  # TODO: Parse from output
    
    return AIResult(
        success=result.returncode == 0,
        response=response,
        tokens_used=tokens,
        error=None if result.returncode == 0 else result.stderr,
        raw_output=result.stdout
    )
```

### Security Considerations

**Tool Permissions:**
- `--allow-tool 'shell(git)'` - Only allow git commands
- `--allow-tool 'shell(*)'` - Allow all shell commands (DANGEROUS)
- `--allow-tool 'write(*)'` - Allow file writes

**Best Practice:**
- Specify exact commands: `'shell(git)'`, `'shell(npm)'`
- Avoid wildcards for delegation
- Review allowed tools before auto-approval

---

## ⚠️ OpenCode CLI - REQUIRES PAYMENT

### Installation
- **Version**: 1.0.223
- **Location**: /Users/shakes/.nvm/versions/node/v22.20.0/bin/opencode
- **Status**: Installed but **requires payment method**

### Command Pattern
```bash
opencode run "prompt"
# OR
opencode serve  # Start headless server (HTTP API)
```

### Test Result
**Command:**
```bash
opencode run "What is 2+2? Brief answer only."
```

**Error:**
```
Error: Unauthorized: {"type":"error","error":{"type":"CreditsError","message":"No payment method. Add a payment method here: https://opencode.ai/workspace/wrk_01KE03Z1NMN5CX8QA6K4HJY708/billing"}}
```

### Findings

**Blocker:** OpenCode requires:
1. Credits/payment method to run
2. Not free tier like Gemini or included like Codex/Copilot

**Alternative Headless Modes:**
- `opencode serve` - HTTP server mode
- `opencode web` - Web interface mode
- Both likely require payment

**Impact on Multi-AI Orchestration:**
- Cannot use for free-tier delegation strategy
- Users need OpenCode subscription/credits
- Not as accessible as Gemini (free) or Codex/Copilot (included plans)

---

## Summary: HeadlessSpawner Compatibility

| AI CLI | Status | Output Format | Free/Included |
|--------|--------|---------------|---------------|
| **Gemini** | ✅ Ready | JSON | ✅ Free tier |
| **Codex** | ✅ Ready | JSONL | ✅ ChatGPT Plus+ |
| **Copilot** | ✅ Ready | Plain text | ✅ GitHub Copilot |
| **OpenCode** | ⚠️ Blocked | Unknown | ❌ Requires payment |

## Recommendations

### Phase 1: Implement Core Three
1. `spawn_gemini()` - ✅ Already implemented
2. `spawn_codex()` - Priority (JSONL parsing)
3. `spawn_copilot()` - Priority (text parsing with stats)

### Phase 2: Optional
4. `spawn_opencode()` - Lower priority (payment required)
5. `spawn_ollama()` - Local alternative (free)

### Parsing Complexity

**Easiest:** Gemini (single JSON object)
**Medium:** Codex (JSONL streaming)
**Harder:** Copilot (text with stats block)
**Unknown:** OpenCode (untested due to payment)

## Next Steps

1. Implement `spawn_codex()` (JSONL)
2. Implement `spawn_copilot()` (text)
3. Add comprehensive tests for all three
4. Document tool approval patterns
5. Consider OpenCode if user has credits

            </div>
        </section>
        <section data-decision>
            <h3>Decision</h3>
            <p>
Implement HeadlessSpawner support for Gemini (done), Codex, and Copilot.

**Priority:**
1. Codex (JSONL parsing, agentic, included with ChatGPT Plus+)
2. Copilot (text parsing, Claude Haiku 4.5, included with GitHub)
3. OpenCode (blocked by payment requirement)

**All three work with subprocess approach!**
</p>
        </section>
    </article>
</body>
</html>
