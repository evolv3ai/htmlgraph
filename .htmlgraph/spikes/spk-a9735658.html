<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="htmlgraph-version" content="1.0">
    <title>Server operations implementation</title>
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
    <article id="spk-a9735658"
             data-type="spike"
             data-status="todo"
             data-priority="medium"
             data-created="2026-01-02T17:39:22.507558"
             data-updated="2026-01-02T17:39:22.507562" data-spike-type="general" data-timebox-hours="4">

        <header>
            <h1>Server operations implementation</h1>
            <div class="metadata">
                <span class="badge status-todo">Todo</span>
                <span class="badge priority-medium">Medium Priority</span>
            </div>
        </header>

    
        <section data-spike-metadata>
            <h3>Spike Metadata</h3>
            <dl>
                <dt>Type</dt>
                <dd>General</dd>
                <dt>Timebox</dt>
                <dd>4 hours</dd>
            </dl>
        </section>
        <section data-findings>
            <h3>Findings</h3>
            <div class="findings-content">
                
## Implementation Complete

Successfully implemented the server operations module by extracting logic from existing server code.

### What Was Implemented

1. **start_server()** - Extract server startup logic
   - Removed all print() statements, returns data instead
   - Returns ServerStartResult with handle, warnings, config_used
   - Raises PortInUseError or ServerStartError on failures
   - Uses Path objects for directories
   - Handles auto-port selection when port is in use
   - Auto-syncs dashboard files before starting
   - Creates graph directories and copies stylesheet
   - Builds analytics index if needed
   - Configures HTTP server handler
   - Optionally starts file watcher for auto-reload

2. **stop_server()** - Gracefully shutdown server
   - Handles dict-style server handles (with httpserver and watcher)
   - Handles direct HTTPServer instances
   - Stops file watcher first, then HTTP server
   - Raises ServerStartError on shutdown failure

3. **get_server_status()** - Check if server is running
   - Returns ServerStatus with running state
   - Checks port availability to determine status
   - Handles None handle gracefully

4. **Helper Functions**
   - _check_port_in_use() - Check if port is occupied
   - _find_available_port() - Find next available port

### Design Principles Followed

✅ NO print() or sys.exit() calls - All operations return data
✅ Returns dataclasses (ServerStartResult, ServerStatus) - Not primitives
✅ Raises appropriate exceptions (PortInUseError, ServerStartError)
✅ Works with Path objects for all directories
✅ Type hints on all functions
✅ Kept all business logic, removed formatting

### Test Coverage

Created comprehensive unit tests in tests/operations/test_server.py:
- ✅ 16 tests, all passing
- ✅ Helper function tests (port checking, port finding)
- ✅ Server start tests (basic, auto-port, dashboard sync, watcher)
- ✅ Server stop tests (dict handle, direct handle, None handle, failures)
- ✅ Server status tests (no handle, running, not running)

### Quality Gates Passed

✅ Type hints on all functions
✅ Returns dataclasses (not primitives)
✅ No print() or sys.exit()
✅ Raises appropriate exceptions
✅ Works with Path objects
✅ mypy type checking: no issues
✅ pytest tests: 16/16 passing

### Integration Notes

The implementation imports from htmlgraph.server for:
- HtmlGraphAPIHandler (handler class)
- sync_dashboard_files() (dashboard sync utility)

This maintains the separation of concerns:
- operations/server.py: Pure business logic (no I/O formatting)
- server.py: Server implementation and presentation logic

            </div>
        </section>
    </article>
</body>
</html>
