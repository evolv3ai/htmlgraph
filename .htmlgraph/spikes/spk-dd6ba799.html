<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="htmlgraph-version" content="1.0">
    <title>Pattern directory bloat investigation</title>
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
    <article id="spk-dd6ba799"
             data-type="spike"
             data-status="todo"
             data-priority="medium"
             data-created="2026-01-01T22:53:00.333504"
             data-updated="2026-01-01T22:53:00.333508" data-spike-type="general" data-timebox-hours="4">

        <header>
            <h1>Pattern directory bloat investigation</h1>
            <div class="metadata">
                <span class="badge status-todo">Todo</span>
                <span class="badge priority-medium">Medium Priority</span>
            </div>
        </header>

    
        <section data-spike-metadata>
            <h3>Spike Metadata</h3>
            <dl>
                <dt>Type</dt>
                <dd>General</dd>
                <dt>Timebox</dt>
                <dd>4 hours</dd>
            </dl>
        </section>
        <section data-findings>
            <h3>Findings</h3>
            <div class="findings-content">
                
## Investigation Results

### Pattern Statistics
**Total patterns**: 2,867 HTML files
**Unique sequences**: 309 unique patterns  
**Duplicate rate**: **88.9%** (2,558 duplicates!)
**Disk usage**: 11 MB

### Root Cause Analysis

**DIAGNOSIS: Bug in Pattern Loading (Missing Sequence Attribute)**

The deduplication logic EXISTS but FAILS because:

1. **Pattern Creation** (`learning.py:183-205`):
   - ✅ Calls `find_by_sequence()` to check for existing patterns
   - ✅ Updates existing pattern if found
   - ✅ Creates new pattern only if not found

2. **Pattern Lookup** (`pattern.py:54-72`):
   - ❌ **BUG**: Checks `hasattr(p, 'sequence')` but sequence is ALWAYS `None`
   - ❌ The `sequence` attribute is never loaded from HTML `data-sequence` attribute
   - ❌ Result: `find_by_sequence()` always returns empty list
   - ❌ Every session creates NEW patterns instead of updating existing ones

3. **Evidence**:
   ```python
   # From HTML files (correct):
   data-sequence='["Bash", "Bash", "Bash"]'
   
   # From loaded Node objects (broken):
   pattern.sequence = None  # ❌ Not parsed!
   ```

4. **Why 88.9% Duplicates**:
   - Common patterns like `["Bash", "Bash", "Bash"]` appear 30+ times
   - Each session creates a NEW pattern file instead of updating existing
   - Deduplication code exists but never runs due to sequence=None

### Pattern Creation Frequency
**Trigger**: Every session end (`auto_persist_on_session_end`)  
**Sessions analyzed**: ~100+ sessions  
**Patterns per session**: ~30 unique sequences × sessions = 2,867 files

### Most Duplicated Patterns
```
31x: ["TodoWrite", "Bash", "Bash"]
30x: ["Bash", "Bash", "TodoWrite"]  
30x: ["SessionStart", "Edit", "SessionEnd"]
30x: ["FeatureClaim", "FeatureStart", "FeatureComplete"]
30x: ["Bash", "Read", "Edit"]
... (and 25+ more with 30 duplicates each)
```

### The Fix

**Location**: `src/python/htmlgraph/converter.py` (NodeConverter class)

**Issue**: The `from_html()` method doesn't parse `data-sequence` attribute from pattern HTML files.

**Required Changes**:
1. Add sequence parsing in `from_html()` for pattern nodes
2. Parse JSON array from `data-sequence='["Tool1", "Tool2", "Tool3"]'`
3. Set `node.sequence` property during load

**Expected Impact**:
- After fix: `find_by_sequence()` will find existing patterns
- New sessions will UPDATE existing patterns instead of creating duplicates
- Pattern count will stabilize at ~309 unique patterns
- Disk usage will drop from 11MB to ~1.2MB (90% reduction)

### Code Locations

**Bug Location**:
- `src/python/htmlgraph/converter.py` - Missing sequence attribute parsing

**Deduplication Logic (Working Correctly)**:
- `src/python/htmlgraph/learning.py:183-205` - `persist_patterns()`
- `src/python/htmlgraph/collections/pattern.py:54-72` - `find_by_sequence()`

### Cleanup Strategy

**After Fix**:
1. Delete all existing pattern files: `rm .htmlgraph/patterns/*.html`
2. Re-run pattern detection: `sdk.learning.persist_patterns()`
3. Result: ~309 patterns instead of 2,867

**Status**: ROOT CAUSE IDENTIFIED - Ready for fix
    
            </div>
        </section>
    </article>
</body>
</html>
