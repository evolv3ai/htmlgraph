<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="htmlgraph-version" content="1.0">
    <title>Parent-Child Session Context Design for Nested Task() Tracking</title>
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
    <article id="spk-e261b822"
             data-type="spike"
             data-status="in-progress"
             data-priority="high"
             data-created="2026-01-04T05:03:21.520104"
             data-updated="2026-01-04T05:15:00.000000"
             data-spike-type="architecture"
             data-timebox-hours="4">

        <header>
            <h1>Parent-Child Session Context Design for Nested Task() Tracking</h1>
            <div class="metadata">
                <span class="badge status-in-progress">In Progress</span>
                <span class="badge priority-high">High Priority</span>
            </div>
        </header>

        <section data-content>
            <h2>Problem Statement</h2>
            <p>HeadlessSpawner tracks external AI activities (Gemini, Codex, Copilot) in real-time by collecting events and calling <code>sdk.track_activity()</code>. This works when called directly, but <strong>fails when called from within a Task()</strong> because:</p>

            <pre><code>
# Inside HeadlessSpawner._get_sdk()
try:
    from htmlgraph.sdk import SDK
    return SDK(agent="spawner")  # FAILS: no active session in Task context
except Exception:
    return None  # Silent failure
            </code></pre>

            <p>The spawner is called from agent scaffolds which run in Task() contexts:</p>
            <pre><code>
Task(
    prompt="Research dashboard UI...",
    subagent_type="htmlgraph:gemini-spawner"  # Runs in isolated context
)
            </code></pre>

            <h2>Research Findings</h2>

            <h3>1. How HtmlGraph Sessions Currently Work</h3>
            <p>Key findings from analyzing <code>session_manager.py</code> and <code>sdk.py</code>:</p>
            <ul>
                <li><strong>Session Creation:</strong> Sessions are created via <code>SessionManager.start_session()</code> which generates a unique ID like <code>sess-{hash}</code></li>
                <li><strong>Session Storage:</strong> Sessions are stored as HTML files in <code>.htmlgraph/sessions/sess-{id}.html</code> with corresponding JSONL event logs</li>
                <li><strong>Active Session Detection:</strong> <code>get_active_session()</code> scans all session files for status="active", then chooses the "canonical" one based on event count and last activity</li>
                <li><strong>Git Commit Binding:</strong> Sessions are bound to git commits via <code>start_commit</code> field - sessions with the same agent AND same commit are deduplicated</li>
                <li><strong>Session Deduplication:</strong> <code>start_session()</code> reuses existing active sessions for the same agent+commit combination, preventing session explosion</li>
            </ul>

            <h3>2. Why SDK Fails in Task() Context</h3>
            <p>When <code>SDK(agent="spawner")</code> is called in a Task() context:</p>
            <ol>
                <li><code>SDK.__init__()</code> calls <code>_discover_htmlgraph()</code> which searches for <code>.htmlgraph/</code> from cwd upward - this usually works</li>
                <li><code>SessionManager</code> is initialized with the graph directory - this works</li>
                <li>When <code>track_activity()</code> is called, it needs an active session</li>
                <li><code>get_active_session(agent="spawner")</code> is called - <strong>this fails because there's no active session for agent "spawner"</strong></li>
                <li>The exception is caught and SDK returns None, causing silent tracking failure</li>
            </ol>

            <h3>3. Environment Variables Already in Use</h3>
            <p>HtmlGraph already uses several environment variables:</p>
            <ul>
                <li><code>HTMLGRAPH_AGENT</code> - Explicit agent name override</li>
                <li><code>HTMLGRAPH_DISABLE_TRACKING</code> - Disables all tracking (used in nested claude calls)</li>
                <li><code>HTMLGRAPH_ORCHESTRATOR_DISABLED</code> - Disables orchestrator enforcement</li>
                <li><code>HTMLGRAPH_PROJECT_DIR</code> / <code>HTMLGRAPH_DIR</code> - Project/graph directory</li>
                <li><code>CLAUDE_CODE_VERSION</code> - Claude Code detection</li>
            </ul>

            <h3>4. Parent Activity Tracking Already Exists</h3>
            <p>In <code>event_tracker.py</code>, there's already a parent-child activity mechanism:</p>
            <ul>
                <li><code>parent-activity.json</code> file tracks active parent context</li>
                <li>When Skill/Task invocations start, their activity ID is saved</li>
                <li>Subsequent activities get <code>parent_activity_id</code> set</li>
                <li>This provides a model for session inheritance</li>
            </ul>

            <h2>Implementation Approaches Comparison</h2>

            <h3>Option A: Auto-Discovery Enhancement</h3>
            <pre><code>
def _get_sdk() -> SDK | None:
    try:
        session_id = (
            os.getenv("HTMLGRAPH_PARENT_SESSION") or
            self._find_active_session_marker() or
            self._infer_from_recent_sessions()
        )
        return SDK(agent="spawner", session_id=session_id)
    except Exception:
        return None
            </code></pre>
            <p><strong>Pros:</strong> No changes to callers needed, works transparently</p>
            <p><strong>Cons:</strong> Fragile discovery logic, race conditions possible, may pick wrong session</p>

            <h3>Option B: Environment Variable Passing (RECOMMENDED)</h3>
            <pre><code>
# In orchestrator before spawning Task:
os.environ["HTMLGRAPH_PARENT_SESSION"] = sdk.session_manager.get_active_session().id
os.environ["HTMLGRAPH_PARENT_AGENT"] = sdk.agent

# In HeadlessSpawner:
def _get_sdk() -> SDK | None:
    parent_session = os.getenv("HTMLGRAPH_PARENT_SESSION")
    parent_agent = os.getenv("HTMLGRAPH_PARENT_AGENT")
    if parent_session:
        return SDK(agent="spawner", parent_session=parent_session)
    return None
            </code></pre>
            <p><strong>Pros:</strong> Explicit, no guessing, works across process boundaries, supports deep nesting</p>
            <p><strong>Cons:</strong> Requires hook/caller changes, env vars may be inherited unexpectedly</p>

            <h3>Option C: Active Session Marker File</h3>
            <pre><code>
# Parent writes marker before spawning
.htmlgraph/active-session.json:
{
    "session_id": "sess-abc123",
    "agent": "orchestrator",
    "spawned_at": "2026-01-04T...",
    "pid": 12345
}

# Child reads marker
def _find_active_session():
    marker = Path(".htmlgraph/active-session.json")
    if marker.exists():
        return json.loads(marker.read_text())["session_id"]
            </code></pre>
            <p><strong>Pros:</strong> Persistent across calls, debuggable (visible file)</p>
            <p><strong>Cons:</strong> File I/O overhead, potential stale data, race conditions with parallel agents</p>

            <h3>Option D: Hybrid Approach (RECOMMENDED)</h3>
            <p>Combine environment variables with marker file fallback:</p>
            <ol>
                <li><strong>Primary:</strong> Check <code>HTMLGRAPH_PARENT_SESSION</code> env var</li>
                <li><strong>Fallback:</strong> Read <code>.htmlgraph/active-session.json</code> marker</li>
                <li><strong>Last resort:</strong> Use existing <code>get_active_session()</code> logic</li>
            </ol>

            <h2>Recommended Design</h2>

            <h3>Core Concept: Session Context Inheritance</h3>
            <p>Subagents inherit session context from their parent through environment variables. Activities are logged to the parent session with a <code>parent_activity_id</code> linking them to the Task() invocation.</p>

            <h3>New Environment Variables</h3>
            <ul>
                <li><code>HTMLGRAPH_PARENT_SESSION</code> - Parent session ID to log activities to</li>
                <li><code>HTMLGRAPH_PARENT_AGENT</code> - Parent agent name for attribution</li>
                <li><code>HTMLGRAPH_PARENT_ACTIVITY</code> - Parent activity ID (the Task() call itself)</li>
            </ul>

            <h3>SDK Changes</h3>
            <pre><code>
class SDK:
    def __init__(
        self,
        directory: Path | str | None = None,
        agent: str | None = None,
        parent_session: str | None = None,  # NEW
    ):
        # ... existing init ...

        # Support parent session inheritance
        self._parent_session = parent_session or os.getenv("HTMLGRAPH_PARENT_SESSION")
        self._parent_agent = os.getenv("HTMLGRAPH_PARENT_AGENT")
        self._parent_activity = os.getenv("HTMLGRAPH_PARENT_ACTIVITY")

    def track_activity(self, ...):
        # If parent session is set, use it instead of finding active session
        if self._parent_session:
            session_id = self._parent_session
            parent_activity_id = self._parent_activity
        else:
            # ... existing logic ...
            </code></pre>

            <h3>Hook Changes (SessionStart)</h3>
            <p>The SessionStart hook should set environment variables before any Task() calls:</p>
            <pre><code>
# In session-start.py after starting session:
active_session = manager.get_active_session()
if active_session:
    os.environ["HTMLGRAPH_PARENT_SESSION"] = active_session.id
    os.environ["HTMLGRAPH_PARENT_AGENT"] = active_session.agent
            </code></pre>

            <h3>HeadlessSpawner Changes</h3>
            <pre><code>
def _get_sdk(self) -> "SDK | None":
    """Get SDK instance for HtmlGraph tracking."""
    try:
        from htmlgraph.sdk import SDK

        # Check for parent session context (works in Task() contexts)
        parent_session = os.getenv("HTMLGRAPH_PARENT_SESSION")
        if parent_session:
            return SDK(agent="spawner", parent_session=parent_session)

        # Fallback to normal initialization
        return SDK(agent="spawner")
    except Exception:
        return None
            </code></pre>

            <h3>Graph Relationships</h3>
            <p>Activities tracked by subagents will have:</p>
            <ul>
                <li><code>session_id</code> - Points to parent session</li>
                <li><code>parent_activity_id</code> - Points to Task() invocation activity</li>
                <li><code>agent</code> - Set to "spawner" or specific spawner type</li>
                <li><code>payload.spawner_type</code> - "gemini", "codex", "copilot", etc.</li>
            </ul>

            <h2>Implementation Plan</h2>

            <h3>Phase 1: Core Infrastructure (2-3 hours)</h3>
            <ol>
                <li>Add <code>parent_session</code> parameter to SDK.__init__()</li>
                <li>Modify <code>track_activity()</code> to use parent session when available</li>
                <li>Add environment variable reading in SDK initialization</li>
                <li>Write unit tests for parent session inheritance</li>
            </ol>

            <h3>Phase 2: Hook Integration (1-2 hours)</h3>
            <ol>
                <li>Update <code>session-start.py</code> hook to set HTMLGRAPH_PARENT_SESSION</li>
                <li>Update <code>track-event.py</code> to propagate parent context</li>
                <li>Ensure environment variables are set before Task() calls</li>
            </ol>

            <h3>Phase 3: HeadlessSpawner Update (1 hour)</h3>
            <ol>
                <li>Update <code>_get_sdk()</code> to use parent session</li>
                <li>Test Gemini, Codex, Copilot spawners with parent context</li>
                <li>Verify events appear in parent session's activity log</li>
            </ol>

            <h3>Phase 4: Testing & Documentation (1-2 hours)</h3>
            <ol>
                <li>Integration tests for nested Task() tracking</li>
                <li>Test deep nesting (Task -> Task -> Task)</li>
                <li>Update documentation</li>
            </ol>

            <h2>Testing Strategy</h2>

            <h3>Unit Tests</h3>
            <pre><code>
def test_sdk_inherits_parent_session():
    """Test SDK uses parent session from env var."""
    os.environ["HTMLGRAPH_PARENT_SESSION"] = "sess-test123"
    sdk = SDK(agent="spawner")
    # Should use parent session for tracking
    assert sdk._parent_session == "sess-test123"

def test_spawner_tracks_to_parent_session():
    """Test HeadlessSpawner tracks to parent session."""
    os.environ["HTMLGRAPH_PARENT_SESSION"] = "sess-parent"
    spawner = HeadlessSpawner()
    sdk = spawner._get_sdk()
    assert sdk is not None
    assert sdk._parent_session == "sess-parent"
            </code></pre>

            <h3>Integration Tests</h3>
            <pre><code>
def test_nested_task_tracking_e2e():
    """Test activities from Task() subagent appear in parent session."""
    # 1. Start parent session
    sdk = SDK(agent="orchestrator")
    session = sdk.start_session()

    # 2. Set parent context (as hook would)
    os.environ["HTMLGRAPH_PARENT_SESSION"] = session.id

    # 3. Simulate spawner activity
    spawner_sdk = SDK(agent="spawner")
    spawner_sdk.track_activity(tool="gemini_spawn", summary="Test spawn")

    # 4. Verify activity appears in parent session
    session = sdk.session_manager.get_session(session.id)
    assert any(a.tool == "gemini_spawn" for a in session.activity_log)
            </code></pre>

            <h2>Migration Path</h2>
            <ol>
                <li><strong>Backward Compatible:</strong> If HTMLGRAPH_PARENT_SESSION is not set, existing behavior continues</li>
                <li><strong>Gradual Rollout:</strong> Update hooks first, then spawners</li>
                <li><strong>No Breaking Changes:</strong> All new functionality is additive</li>
            </ol>

            <h2>Risk Assessment</h2>
            <ul>
                <li><strong>Low Risk:</strong> Environment variable approach is well-tested pattern</li>
                <li><strong>Medium Risk:</strong> Hook order matters - SessionStart must run before PreToolUse</li>
                <li><strong>Low Risk:</strong> Fallback to existing behavior if env var not set</li>
            </ul>
        </section>

        <section data-spike-metadata>
            <h3>Spike Metadata</h3>
            <dl>
                <dt>Type</dt>
                <dd>Architecture</dd>
                <dt>Timebox</dt>
                <dd>4 hours</dd>
                <dt>Investigator</dt>
                <dd>Claude (Opus 4.5)</dd>
            </dl>
        </section>

        <section data-findings>
            <h3>Key Findings</h3>
            <ol>
                <li>SDK session detection relies on scanning files - works but not Task()-aware</li>
                <li>Parent-child activity tracking already exists via parent-activity.json</li>
                <li>Environment variables are the cleanest approach for cross-process context</li>
                <li>Hybrid approach (env var + marker file fallback) provides best reliability</li>
            </ol>
        </section>

        <section data-recommendations>
            <h3>Recommendations</h3>
            <ol>
                <li><strong>Use Environment Variables:</strong> HTMLGRAPH_PARENT_SESSION, HTMLGRAPH_PARENT_AGENT, HTMLGRAPH_PARENT_ACTIVITY</li>
                <li><strong>Modify SDK:</strong> Add parent_session parameter and env var reading</li>
                <li><strong>Update Hooks:</strong> Set parent context in SessionStart hook</li>
                <li><strong>Update HeadlessSpawner:</strong> Use parent session in _get_sdk()</li>
            </ol>
        </section>
    </article>
</body>
</html>
