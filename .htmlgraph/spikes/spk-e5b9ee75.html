<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="htmlgraph-version" content="1.0">
    <title>HeadlessSpawner Implementation - Gemini CLI Integration</title>
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
    <article id="spk-e5b9ee75"
             data-type="spike"
             data-status="todo"
             data-priority="medium"
             data-created="2026-01-02T19:32:51.783914"
             data-updated="2026-01-02T19:32:51.783920" data-spike-type="technical" data-timebox-hours="4">

        <header>
            <h1>HeadlessSpawner Implementation - Gemini CLI Integration</h1>
            <div class="metadata">
                <span class="badge status-todo">Todo</span>
                <span class="badge priority-medium">Medium Priority</span>
            </div>
        </header>

    
        <section data-spike-metadata>
            <h3>Spike Metadata</h3>
            <dl>
                <dt>Type</dt>
                <dd>Technical</dd>
                <dt>Timebox</dt>
                <dd>4 hours</dd>
            </dl>
        </section>
        <section data-findings>
            <h3>Findings</h3>
            <div class="findings-content">
                
# Implementation Summary

Successfully implemented HeadlessSpawner class for programmatic multi-AI orchestration via CLI.

## Files Created

1. **src/python/htmlgraph/orchestration/headless_spawner.py** (120 lines)
   - AIResult dataclass for structured results
   - HeadlessSpawner class with spawn_gemini() method
   - Full error handling (timeout, CLI not found, JSON parse errors)

2. **src/python/htmlgraph/orchestration/__init__.py** (25 lines)
   - Exports HeadlessSpawner, AIResult
   - Exports task coordination helpers (delegate_with_id, etc.)

3. **tests/python/test_headless_spawner.py** (152 lines)
   - 9 comprehensive test cases
   - Tests basic usage, error handling, timeout, complex prompts
   - Integration test verifying Gemini CLI availability

## Module Reorganization

- Moved existing orchestration.py → orchestration/task_coordination.py
- Created orchestration/ package with proper __init__.py
- Maintains backward compatibility with existing imports

## Key Implementation Details

### Command Pattern
```python
cmd = ["gemini", "-p", prompt, "--output-format", "json"]
subprocess.run(cmd, stdout=PIPE, stderr=DEVNULL, timeout=timeout)
```

### JSON Response Structure Discovery
Initial assumption was wrong (based on spike notes). Actual structure:
```json
{
  "response": "4",
  "stats": {
    "models": {
      "gemini-2.5-flash-lite": {
        "tokens": {"total": 3234, ...}
      }
    }
  }
}
```

NOT: `output["result"]["response"]` ❌
CORRECT: `output["response"]` ✅

### Token Calculation
Sums tokens across all models used in session:
```python
total_tokens = sum(
    model["tokens"]["total"]
    for model in stats["models"].values()
)
```

### Error Handling
- FileNotFoundError → "Gemini CLI not found"
- TimeoutExpired → "Gemini CLI timed out after X seconds"
- JSONDecodeError → "Failed to parse JSON output"
- Non-zero exit code → "Gemini CLI failed with exit code X"

## Test Results

```
9 passed in 161.93s (0:02:41)
```

All tests pass including:
- ✅ Basic spawning with correct response
- ✅ Token counting works
- ✅ JSON format option
- ✅ Empty prompt handling
- ✅ Timeout handling
- ✅ Complex multi-line prompts
- ✅ AIResult dataclass structure
- ✅ Integration test (Gemini CLI available)

## Quality Gates

- ✅ Tests: 9/9 passing
- ✅ Mypy: No errors (3 files checked)
- ✅ Ruff: 1 auto-fix applied, all clean

## Example Usage

```python
from htmlgraph.orchestration import HeadlessSpawner

spawner = HeadlessSpawner()
result = spawner.spawn_gemini("Analyze this code...")

if result.success:
    print(result.response)
    print(f"Tokens used: {result.tokens_used}")
else:
    print(f"Error: {result.error}")
```

## Challenges Solved

1. **subprocess API gotcha**: Cannot use `capture_output=True` with `stderr=DEVNULL`
   - Solution: Use `stdout=PIPE, stderr=DEVNULL` explicitly

2. **JSON structure mismatch**: Spike notes showed different structure
   - Solution: Inspected actual output, found response at top level

3. **Module organization**: Existing orchestration.py conflicted with new orchestration/
   - Solution: Moved to orchestration/task_coordination.py, proper package structure

## Next Steps

1. **Add Claude CLI support** - Implement spawn_claude() method
2. **Add Copilot support** - Implement spawn_copilot() if CLI exists
3. **Add OpenCode support** - Implement spawn_opencode()
4. **SDK integration** - Add sdk.orchestration.spawn_ai() convenience method
5. **Streaming support** - Add stream_gemini() for real-time output
6. **Multi-AI coordination** - Parallel spawning across different AIs

            </div>
        </section>
        <section data-decision>
            <h3>Decision</h3>
            <p>Implementation successful. HeadlessSpawner.spawn_gemini() ready for production use. Recommend implementing other AI CLI spawners next.</p>
        </section>
    </article>
</body>
</html>
