<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="htmlgraph-version" content="1.0">
    <title>HeadlessSpawner Error Handling & Reliability Review</title>
    <link rel="stylesheet" href="../styles.css">
</head>
<body>
    <article id="spk-e7385d6c"
             data-type="spike"
             data-status="todo"
             data-priority="medium"
             data-created="2026-01-04T03:46:03.341052"
             data-updated="2026-01-04T03:46:03.341056" data-spike-type="general" data-timebox-hours="4">

        <header>
            <h1>HeadlessSpawner Error Handling & Reliability Review</h1>
            <div class="metadata">
                <span class="badge status-todo">Todo</span>
                <span class="badge priority-medium">Medium Priority</span>
            </div>
        </header>

    
        <section data-spike-metadata>
            <h3>Spike Metadata</h3>
            <dl>
                <dt>Type</dt>
                <dd>General</dd>
                <dt>Timebox</dt>
                <dd>4 hours</dd>
            </dl>
        </section>
        <section data-findings>
            <h3>Findings</h3>
            <div class="findings-content">
                
# HeadlessSpawner Code Review: Error Handling & Reliability

## 1. Error Handling Consistency Analysis

### ✅ CONSISTENT ERROR HANDLING PATTERNS

All four spawn methods follow similar error handling structure:
- **FileNotFoundError** - CLI not installed
- **subprocess.TimeoutExpired** - Timeout exceeded
- **Generic Exception** - Unexpected errors (Gemini, Claude only)

### ❌ INCONSISTENCIES IDENTIFIED

#### A. Missing Generic Exception Handler in spawn_codex()
**spawn_codex()** only catches FileNotFoundError and TimeoutExpired, missing generic Exception handler.

**Risk**: Unhandled exceptions (e.g., PermissionError, OSError) will crash instead of returning AIResult.

**Evidence**:
```python
# spawn_gemini (lines 169-176) - HAS generic handler ✓
except Exception as e:
    return AIResult(
        success=False,
        response="",
        tokens_used=None,
        error=f"Unexpected error: {type(e).__name__}: {e}",
        raw_output=None,
    )

# spawn_codex (lines 316-331) - MISSING generic handler ✗
except FileNotFoundError:
    ...
except subprocess.TimeoutExpired:
    ...
# NO generic Exception handler!

# spawn_claude (lines 551-558) - HAS generic handler ✓
except Exception as e:
    return AIResult(
        success=False,
        response="",
        tokens_used=None,
        error=f"Unexpected error: {str(e)}",
        raw_output=None,
    )
```

#### B. Missing Generic Exception Handler in spawn_copilot()
**spawn_copilot()** also missing generic Exception handler.

**Evidence**:
```python
# spawn_copilot (lines 409-424) - MISSING generic handler ✗
except FileNotFoundError:
    ...
except subprocess.TimeoutExpired:
    ...
# NO generic Exception handler!
```

#### C. Inconsistent Exception Message Format
- spawn_gemini: `f"Unexpected error: {type(e).__name__}: {e}"`
- spawn_claude: `f"Unexpected error: {str(e)}"`

**Impact**: Minor - Both work, but inconsistent formatting makes debugging harder.

---

## 2. Timeout Handling Analysis

### ✅ CORRECT TIMEOUT IMPLEMENTATION

All methods correctly:
1. Accept `timeout` parameter (default: 120s for most, 300s for Claude)
2. Pass to subprocess.run(timeout=timeout)
3. Catch subprocess.TimeoutExpired exception
4. Return AIResult with descriptive error message

### ⚠️ TIMEOUT EDGE CASES NOT HANDLED

#### A. No Process Cleanup on Timeout
When subprocess times out, the child process may continue running.

**Risk**: Zombie processes accumulating, consuming resources.

**Evidence**: No process.kill() or process.terminate() calls in timeout handlers.

#### B. No Partial Output Capture on Timeout
subprocess.TimeoutExpired exception includes partial stdout/stderr, but we discard it.

**Current behavior**:
```python
except subprocess.TimeoutExpired:
    return AIResult(
        success=False,
        response="",  # Lost partial output!
        tokens_used=None,
        error=f"Timed out after {timeout} seconds",
        raw_output=None,  # Could include partial data
    )
```

**Missed opportunity**: Could return partial response for debugging.

---

## 3. Concrete Reliability Improvement

### RECOMMENDATION: Add Generic Exception Handler to All Methods

**Priority**: HIGH - Prevents crashes on unexpected errors

**Implementation**:

```python
def spawn_codex(self, ...) -> AIResult:
    """..."""
    cmd = ["codex", "exec"]
    # ... build command ...

    try:
        result = subprocess.run(...)
        # ... parse output ...

    except FileNotFoundError:
        return AIResult(...)
    except subprocess.TimeoutExpired as e:
        # IMPROVED: Capture partial output
        return AIResult(
            success=False,
            response="",
            tokens_used=None,
            error=f"Timed out after {timeout} seconds",
            raw_output={
                "partial_stdout": e.stdout.decode() if e.stdout else None,
                "partial_stderr": e.stderr.decode() if e.stderr else None,
            } if e.stdout or e.stderr else None,
        )
    except Exception as e:
        # NEW: Catch all unexpected errors
        return AIResult(
            success=False,
            response="",
            tokens_used=None,
            error=f"Unexpected error: {type(e).__name__}: {e}",
            raw_output=None,
        )
```

**Benefits**:
1. ✅ Prevents crashes - Always returns AIResult
2. ✅ Better debugging - Captures partial output on timeout
3. ✅ Consistent - All methods handle errors uniformly
4. ✅ Graceful degradation - Agent scaffolds can detect and fallback

---

## 4. Additional Issues Found

### A. Empty Response Detection
Tests show awareness of empty response issue (see test_headless_spawner.py line 239):
```python
# Agent scaffold should detect quota error and fallback
assert result.success is True  # Copilot returns 0 even on quota exceeded
assert "quota" in result.response.lower()
```

**Current handling**: Agent scaffolds must detect empty/error responses manually.

**Improvement opportunity**: HeadlessSpawner could detect common error patterns.

### B. JSON Parsing Error Handling
Only spawn_gemini and spawn_claude handle JSON parsing errors explicitly.

**spawn_codex** silently continues on JSON parse errors:
```python
# Line 286-290
for line in result.stdout.splitlines():
    if line.strip():
        try:
            events.append(json.loads(line))
        except json.JSONDecodeError:
            continue  # Silent failure!
```

**Risk**: Malformed JSONL could result in empty events list, returning empty response.

---

## 5. Test Coverage Analysis

### ✅ Well-Tested Error Paths
- FileNotFoundError (all methods)
- TimeoutExpired (Gemini, Codex tested)
- JSON parse errors (Gemini tested)
- CLI failures / non-zero exit codes (Gemini tested)

### ⚠️ Untested Error Paths
- Generic exceptions (OSError, PermissionError, etc.)
- Partial output on timeout
- Empty JSONL events in spawn_codex
- spawn_copilot timeout handling (no test)

---

## Summary

**Critical Issues**:
1. ❌ spawn_codex missing generic Exception handler
2. ❌ spawn_copilot missing generic Exception handler
3. ⚠️ Timeout handlers don't capture partial output

**Recommended Fix** (Priority Order):
1. Add generic Exception handler to spawn_codex() and spawn_copilot()
2. Capture partial output in timeout handlers
3. Standardize exception message formatting
4. Add JSON parse error handling to spawn_codex()

            </div>
        </section>
    </article>
</body>
</html>
