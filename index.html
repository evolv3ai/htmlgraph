<!DOCTYPE html>
<html lang="en" data-theme="system">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HtmlGraph Dashboard</title>
    <!-- d3-force for graph layout simulation -->
    <script src="https://d3js.org/d3-dispatch.v3.min.js"></script>
    <script src="https://d3js.org/d3-quadtree.v3.min.js"></script>
    <script src="https://d3js.org/d3-timer.v3.min.js"></script>
    <script src="https://d3js.org/d3-force.v3.min.js"></script>
    <!-- Typography: JetBrains Mono + Outfit -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* ================================================================
           COLOR SYSTEM & THEME
           ================================================================ */
        :root {
            /* Light Theme (default) */
            --bg-primary: #F8F7F4;
            --bg-secondary: #FFFFFF;
            --bg-tertiary: #EEEDE8;
            --text-primary: #0A0A0A;
            --text-secondary: #4A4A4A;
            --text-muted: #8A8A8A;
            --border: #E0DED8;
            --border-strong: #0A0A0A;

            /* Accent Colors */
            --accent: #CDFF00;
            --accent-dim: #B8E600;
            --accent-text: #0A0A0A;

            /* Status Colors - Vivid */
            --status-done: #00C853;
            --status-active: #2979FF;
            --status-blocked: #FF1744;
            --status-todo: #78909C;

            /* Priority Colors */
            --priority-critical: #FF1744;
            --priority-high: #FF9100;
            --priority-medium: #2979FF;
            --priority-low: #78909C;

            /* Shadows - Sharp, not soft */
            --shadow-sm: 2px 2px 0 var(--border-strong);
            --shadow-md: 4px 4px 0 var(--border-strong);
            --shadow-lg: 6px 6px 0 var(--border-strong);
            --shadow-hover: 8px 8px 0 var(--border-strong);

            /* Timing */
            --ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);
            --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* Dark Theme - Softer contrast for eye comfort */
        [data-theme="dark"] {
            --bg-primary: #151518;
            --bg-secondary: #1C1C20;
            --bg-tertiary: #252528;
            --text-primary: #E0DED8;
            --text-secondary: #A0A0A0;
            --text-muted: #707070;
            --border: #333338;
            --border-strong: #606068;

            --shadow-sm: 2px 2px 0 rgba(0, 0, 0, 0.4);
            --shadow-md: 4px 4px 0 rgba(0, 0, 0, 0.4);
            --shadow-lg: 6px 6px 0 rgba(0, 0, 0, 0.4);
            --shadow-hover: 8px 8px 0 rgba(0, 0, 0, 0.4);
        }

        /* System preference */
        @media (prefers-color-scheme: dark) {
            [data-theme="system"] {
                --bg-primary: #151518;
                --bg-secondary: #1C1C20;
                --bg-tertiary: #252528;
                --text-primary: #E0DED8;
                --text-secondary: #A0A0A0;
                --text-muted: #707070;
                --border: #333338;
                --border-strong: #606068;

                --shadow-sm: 2px 2px 0 rgba(0, 0, 0, 0.4);
                --shadow-md: 4px 4px 0 rgba(0, 0, 0, 0.4);
                --shadow-lg: 6px 6px 0 rgba(0, 0, 0, 0.4);
                --shadow-hover: 8px 8px 0 rgba(0, 0, 0, 0.4);
            }
        }

        /* ================================================================
           BASE STYLES
           ================================================================ */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Outfit', system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        /* Subtle grain texture overlay */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
            opacity: 0.03;
            pointer-events: none;
            z-index: 9999;
        }

        .container {
            max-width: 1440px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* ================================================================
           HEADER
           ================================================================ */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 3rem;
            padding-bottom: 2rem;
            border-bottom: 2px solid var(--border-strong);
        }

        .brand {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .brand-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2rem;
            font-weight: 700;
            letter-spacing: -0.02em;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .brand-title::before {
            content: '<>';
            color: var(--accent);
            font-weight: 400;
        }

        .brand-tagline {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-muted);
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* Theme Toggle */
        .theme-toggle {
            width: 44px;
            height: 44px;
            border: 2px solid var(--border-strong);
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: all 0.2s var(--ease-out-expo);
            box-shadow: var(--shadow-sm);
        }

        .theme-toggle:hover {
            transform: translate(-2px, -2px);
            box-shadow: var(--shadow-md);
        }

        .theme-toggle:active {
            transform: translate(0, 0);
            box-shadow: none;
        }

        /* ================================================================
           STATS BAR
           ================================================================ */
        .stats-bar {
            display: flex;
            gap: 1px;
            background: var(--border-strong);
            border: 2px solid var(--border-strong);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .stat {
            flex: 1;
            background: var(--bg-secondary);
            padding: 1.25rem 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            position: relative;
        }

        .stat::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--accent);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s var(--ease-out-expo);
        }

        .stat:hover::after {
            transform: scaleX(1);
        }

        .stat-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2rem;
            font-weight: 700;
            line-height: 1;
        }

        .stat-label {
            font-size: 0.6875rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--text-muted);
            font-weight: 500;
        }

        .stat.highlight .stat-value {
            color: var(--accent);
        }

        /* ================================================================
           VIEW TOGGLE
           ================================================================ */
        .view-toggle {
            display: flex;
            gap: 0;
            margin-bottom: 2rem;
            border: 2px solid var(--border-strong);
            width: fit-content;
        }

        .view-btn {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            padding: 0.875rem 1.5rem;
            border: none;
            background: var(--bg-secondary);
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s var(--ease-out-expo);
            position: relative;
        }

        .view-btn:not(:last-child) {
            border-right: 2px solid var(--border-strong);
        }

        .view-btn:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }

        .view-btn.active {
            background: var(--accent);
            color: var(--accent-text);
        }

        /* ================================================================
           KANBAN BOARD
           ================================================================ */
        .kanban {
            display: none;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
        }

        .kanban.active {
            display: grid;
        }

        /* Dynamic grid: expanded columns grow, collapsed stay fixed */
        .kanban.has-collapsed {
            grid-template-columns: var(--kanban-grid, repeat(4, 1fr));
        }

        @media (max-width: 1200px) {
            .kanban:not(.has-collapsed) { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
            .kanban { grid-template-columns: 1fr !important; }
            .column.collapsed {
                max-width: none;
                min-width: 0;
                flex-direction: row;
            }
            .column.collapsed .column-header {
                writing-mode: horizontal-tb;
                flex-direction: row;
                height: auto;
                border-bottom: 2px solid var(--border-strong);
            }
            .column.collapsed .column-cards {
                display: flex;
            }
        }

        .column {
            background: var(--bg-secondary);
            border: 2px solid var(--border-strong);
            box-shadow: var(--shadow-md);
            display: flex;
            flex-direction: column;
            max-height: 70vh;
            transition: all 0.3s var(--ease-out-expo);
            min-width: 0;
        }

        .column.collapsed {
            min-width: 52px;
            max-width: 52px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            align-self: stretch;
        }

        /* When all columns are collapsed, center them */
        .kanban.all-collapsed {
            justify-content: center;
        }

        /* Status-colored accent strip on collapsed columns */
        .column.collapsed::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--status-todo);
            transition: width 0.3s var(--ease-out-expo);
        }
        .column.collapsed.in-progress::before { background: var(--status-active); }
        .column.collapsed.blocked::before { background: var(--status-blocked); }
        .column.collapsed.done::before { background: var(--status-done); }

        /* Breathing glow on hover to hint expandability */
        .column.collapsed:hover::before {
            width: 6px;
            box-shadow: 0 0 12px currentColor;
        }
        .column.collapsed:hover {
            background: var(--bg-tertiary);
        }

        .column.collapsed .column-header {
            flex-direction: column;
            padding: 0.75rem 0.5rem;
            gap: 0.5rem;
            align-items: center;
            justify-content: flex-start;
            height: auto;
            border-bottom: none;
            background: transparent;
        }

        .column.collapsed .column-header-left {
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            order: 1;
        }

        .column.collapsed .column-count {
            writing-mode: horizontal-tb;
            font-size: 1.25rem;
            font-weight: 800;
            background: transparent;
            border: none;
            padding: 0;
            order: -1;
        }

        .column.collapsed .column-title {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            white-space: nowrap;
            font-size: 0.625rem;
            letter-spacing: 0.2em;
        }

        .column.collapsed .column-title::before {
            display: none;
        }

        .column.collapsed .column-cards {
            display: none;
        }

        /* Collapse button at top of collapsed column */
        .column.collapsed .collapse-btn {
            writing-mode: horizontal-tb;
            transform: rotate(0deg);
            border: none;
            background: transparent;
            opacity: 0.5;
            order: -2;
            flex-shrink: 0;
        }

        .column.collapsed:hover .collapse-btn {
            opacity: 1;
        }

        .column-header {
            padding: 1rem 1.25rem;
            border-bottom: 2px solid var(--border-strong);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-tertiary);
        }

        .column-header-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        /* Refined collapse button with chevron */
        .collapse-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s var(--ease-out-expo);
            position: relative;
        }

        .collapse-btn::before,
        .collapse-btn::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 2px;
            background: currentColor;
            transition: transform 0.2s var(--ease-out-expo);
        }

        .collapse-btn::before {
            transform: rotate(-45deg) translateY(-2px);
        }

        .collapse-btn::after {
            transform: rotate(45deg) translateY(2px);
        }

        .collapse-btn:hover {
            color: var(--text-primary);
        }

        .collapse-btn:hover::before {
            transform: rotate(-45deg) translateY(-2px) translateX(-2px);
        }

        .collapse-btn:hover::after {
            transform: rotate(45deg) translateY(2px) translateX(-2px);
        }

        /* Expanded state chevron points left */
        .column:not(.collapsed) .collapse-btn::before,
        .column:not(.collapsed) .collapse-btn::after {
            transform-origin: center;
        }

        /* Collapsed state chevron points right */
        .column.collapsed .collapse-btn::before {
            transform: rotate(45deg) translateY(-2px);
        }

        .column.collapsed .collapse-btn::after {
            transform: rotate(-45deg) translateY(2px);
        }

        .column.collapsed .collapse-btn:hover::before {
            transform: rotate(45deg) translateY(-2px) translateX(2px);
        }

        .column.collapsed .collapse-btn:hover::after {
            transform: rotate(-45deg) translateY(2px) translateX(2px);
        }

        .column-title {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .column-title::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--status-todo);
            flex-shrink: 0;
        }

        .column.in-progress .column-title::before { background: var(--status-active); }
        .column.blocked .column-title::before { background: var(--status-blocked); }
        .column.done .column-title::before { background: var(--status-done); }

        .column-count {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            font-weight: 700;
            background: var(--bg-primary);
            padding: 0.25rem 0.5rem;
            border: 1px solid var(--border);
        }

        .column-cards {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        /* ================================================================
           CARDS
           ================================================================ */
        .card {
            background: var(--bg-primary);
            border: 2px solid var(--border-strong);
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s var(--ease-out-expo);
            box-shadow: var(--shadow-sm);
            position: relative;
            animation: cardReveal 0.4s var(--ease-out-expo) backwards;
        }

        @keyframes cardReveal {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
        }

        .card:hover {
            transform: translate(-4px, -4px);
            box-shadow: var(--shadow-hover);
        }

        .card:active {
            transform: translate(0, 0);
            box-shadow: none;
        }

        .card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--priority-medium);
        }

        .card.priority-critical::before { background: var(--priority-critical); }
        .card.priority-high::before { background: var(--priority-high); }
        .card.priority-medium::before { background: var(--priority-medium); }
        .card.priority-low::before { background: var(--priority-low); }

        .card-title {
            font-weight: 600;
            font-size: 0.9375rem;
            margin-bottom: 0.75rem;
            line-height: 1.3;
        }

        .card-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
        }

        .badge {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.625rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0.25rem 0.5rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
        }

        .badge.priority-critical { background: var(--priority-critical); color: white; border-color: var(--priority-critical); }
        .badge.priority-high { background: var(--priority-high); color: white; border-color: var(--priority-high); }
        .badge.type { background: var(--accent); color: var(--accent-text); border-color: var(--accent); }

        .card-path {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.625rem;
            color: var(--text-muted);
            margin-left: auto;
        }

        .empty-column {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--text-muted);
            font-size: 0.875rem;
            border: 2px dashed var(--border);
            margin: 1rem;
        }

        /* ================================================================
           GRAPH VIEW
           ================================================================ */
        .graph-container {
            display: none;
            background: var(--bg-secondary);
            border: 2px solid var(--border-strong);
            box-shadow: var(--shadow-md);
        }

        .graph-container.active {
            display: block;
        }

        .graph-svg {
            width: 100%;
            height: 600px;
            display: block;
        }

        .graph-node {
            cursor: pointer;
        }

        .graph-node circle {
            stroke: var(--border-strong);
            stroke-width: 2;
            transition: all 0.2s var(--ease-out-expo);
        }

        .graph-node:hover circle {
            stroke-width: 4;
        }

        .graph-node text {
            font-family: 'JetBrains Mono', monospace;
            font-size: 8px;
            font-weight: 500;
            fill: white;
            text-anchor: middle;
            pointer-events: none;
        }

        .graph-edge {
            stroke: var(--border);
            stroke-width: 2;
            fill: none;
        }

        .graph-edge.blocked_by {
            stroke: var(--status-blocked);
            stroke-dasharray: 6, 4;
        }

        .graph-edge.related {
            stroke: var(--status-active);
        }

        .graph-arrowhead {
            fill: var(--border);
        }

        .graph-legend {
            display: flex;
            gap: 2rem;
            justify-content: center;
            padding: 1rem;
            border-top: 2px solid var(--border-strong);
            background: var(--bg-tertiary);
        }

        .graph-legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.6875rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
        }

        .graph-legend-item span {
            width: 24px;
            height: 3px;
        }

        .legend-blocked { background: var(--status-blocked); }
        .legend-related { background: var(--status-active); }
        .legend-default { background: var(--border); }

        /* ================================================================
           DETAIL PANEL
           ================================================================ */
        .panel-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10, 10, 10, 0.6);
            backdrop-filter: blur(4px);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s var(--ease-out-expo);
            z-index: 100;
        }

        .panel-overlay.open {
            opacity: 1;
            visibility: visible;
        }

        .panel {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: 520px;
            max-width: 100%;
            background: var(--bg-secondary);
            border-left: 2px solid var(--border-strong);
            transform: translateX(100%);
            transition: transform 0.4s var(--ease-spring);
            z-index: 101;
            display: flex;
            flex-direction: column;
        }

        .panel.open {
            transform: translateX(0);
        }

        .panel-header {
            padding: 1.5rem;
            border-bottom: 2px solid var(--border-strong);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
            background: var(--bg-tertiary);
        }

        .panel-header h2 {
            font-size: 1.25rem;
            font-weight: 700;
            line-height: 1.3;
            flex: 1;
        }

        .panel-close {
            width: 40px;
            height: 40px;
            border: 2px solid var(--border-strong);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s var(--ease-out-expo);
            flex-shrink: 0;
        }

        .panel-close:hover {
            background: var(--accent);
            color: var(--accent-text);
        }

        .panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .panel-section {
            margin-bottom: 2rem;
        }

        .panel-section:last-child {
            margin-bottom: 0;
        }

        .panel-section h3 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.625rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .panel-meta {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .panel-meta .badge {
            font-size: 0.75rem;
            padding: 0.375rem 0.625rem;
        }

        /* Steps */
        .steps-list {
            list-style: none;
        }

        .step-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
        }

        .step-item:last-child {
            border-bottom: none;
        }

        .step-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--accent);
            flex-shrink: 0;
            margin-top: 2px;
        }

        .step-text {
            flex: 1;
            font-size: 0.9375rem;
        }

        .step-text.completed {
            text-decoration: line-through;
            color: var(--text-muted);
        }

        .step-agent {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.6875rem;
            color: var(--text-muted);
        }

        /* Edges */
        .edge-list {
            list-style: none;
        }

        .edge-item {
            padding: 0.5rem 0;
        }

        .edge-item a {
            color: var(--status-active);
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
            transition: color 0.2s;
        }

        .edge-item a:hover {
            color: var(--accent);
        }

        .edge-type {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.6875rem;
            color: var(--text-muted);
            margin-left: 0.5rem;
        }

        /* Content */
        .panel-content {
            line-height: 1.7;
            color: var(--text-secondary);
        }

        .panel-content p {
            margin-bottom: 1rem;
        }

        .panel-content ul, .panel-content ol {
            margin-bottom: 1rem;
            padding-left: 1.5rem;
        }

        .panel-timestamps {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Actions */
        .panel-actions {
            padding: 1rem 1.5rem;
            border-top: 2px solid var(--border-strong);
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            background: var(--bg-tertiary);
        }

        .btn {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 0.75rem 1.25rem;
            border: 2px solid var(--border-strong);
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s var(--ease-out-expo);
            box-shadow: var(--shadow-sm);
        }

        .btn:hover {
            transform: translate(-2px, -2px);
            box-shadow: var(--shadow-md);
        }

        .btn:active {
            transform: translate(0, 0);
            box-shadow: none;
        }

        .btn-primary {
            background: var(--accent);
            color: var(--accent-text);
            border-color: var(--accent);
        }

        .btn-success {
            background: var(--status-done);
            color: white;
            border-color: var(--status-done);
        }

        .btn-warning {
            background: var(--priority-high);
            color: white;
            border-color: var(--priority-high);
        }

        .btn-danger {
            background: var(--status-blocked);
            color: white;
            border-color: var(--status-blocked);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="brand">
                <h1 class="brand-title">HtmlGraph</h1>
                <p class="brand-tagline">HTML is All You Need</p>
            </div>
            <div class="header-actions">
                <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
                    <span class="theme-icon">&#9788;</span>
                </button>
            </div>
        </header>

        <!-- Stats Bar -->
        <div class="stats-bar" id="stats">
            <div class="stat"><span class="stat-value">-</span><span class="stat-label">Total</span></div>
            <div class="stat highlight"><span class="stat-value">-</span><span class="stat-label">Done</span></div>
            <div class="stat"><span class="stat-value">-</span><span class="stat-label">Active</span></div>
            <div class="stat"><span class="stat-value">-</span><span class="stat-label">Blocked</span></div>
        </div>

        <!-- View Toggle -->
        <div class="view-toggle">
            <button class="view-btn active" data-view="kanban">Kanban</button>
            <button class="view-btn" data-view="graph">Graph</button>
        </div>

        <!-- Kanban View -->
        <div class="kanban active" id="kanban"></div>

        <!-- Graph View -->
        <div class="graph-container" id="graph-container">
            <svg class="graph-svg" id="graph-svg">
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="55" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" class="graph-arrowhead"/>
                    </marker>
                </defs>
                <g id="graph-edges"></g>
                <g id="graph-nodes"></g>
            </svg>
            <div class="graph-legend">
                <div class="graph-legend-item"><span class="legend-blocked"></span> Blocked by</div>
                <div class="graph-legend-item"><span class="legend-related"></span> Related</div>
                <div class="graph-legend-item"><span class="legend-default"></span> Other</div>
            </div>
        </div>
    </div>

    <!-- Detail Panel -->
    <div class="panel-overlay" id="panel-overlay"></div>
    <div class="panel" id="panel">
        <div class="panel-header">
            <h2 id="panel-title">Loading...</h2>
            <button class="panel-close" id="panel-close">&times;</button>
        </div>
        <div class="panel-body" id="panel-body">
            <div class="loading">Loading...</div>
        </div>
        <div class="panel-actions" id="panel-actions"></div>
    </div>

    <script>
        // =====================================================================
        // Theme Toggle
        // =====================================================================

        const themeToggle = document.getElementById('theme-toggle');
        const themeIcon = themeToggle.querySelector('.theme-icon');

        function getTheme() {
            const stored = localStorage.getItem('theme');
            if (stored) return stored;
            return 'system';
        }

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            updateThemeIcon(theme);
        }

        function updateThemeIcon(theme) {
            const isDark = theme === 'dark' ||
                (theme === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);
            themeIcon.innerHTML = isDark ? '&#9790;' : '&#9788;';
        }

        themeToggle.addEventListener('click', () => {
            const current = getTheme();
            const next = current === 'light' ? 'dark' : current === 'dark' ? 'system' : 'light';
            setTheme(next);
        });

        // Initialize theme
        setTheme(getTheme());

        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
            if (getTheme() === 'system') {
                updateThemeIcon('system');
            }
        });

        // =====================================================================
        // Constants
        // =====================================================================

        const API = '/api';
        const STATUSES = ['todo', 'in-progress', 'blocked', 'done'];
        const STATUS_LABELS = {
            'in-progress': 'In Progress',
            'todo': 'Todo',
            'blocked': 'Blocked',
            'done': 'Done'
        };

        let allNodes = [];
        let currentNode = null;

        // =====================================================================
        // Data Loading
        // =====================================================================

        async function loadData() {
            const [status, query] = await Promise.all([
                fetch(`${API}/status`).then(r => r.json()),
                fetch(`${API}/query`).then(r => r.json())
            ]);
            allNodes = query.nodes;
            return { status, nodes: query.nodes };
        }

        async function loadNode(collection, id) {
            const res = await fetch(`${API}/${collection}/${id}`);
            if (!res.ok) throw new Error('Node not found');
            return res.json();
        }

        async function updateNode(collection, id, data) {
            const res = await fetch(`${API}/${collection}/${id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            if (!res.ok) throw new Error('Update failed');
            return res.json();
        }

        // =====================================================================
        // Rendering
        // =====================================================================

        function renderStats(status) {
            const s = status.by_status || {};
            const stats = document.getElementById('stats');
            stats.innerHTML = `
                <div class="stat"><span class="stat-value">${status.total_nodes}</span><span class="stat-label">Total</span></div>
                <div class="stat highlight"><span class="stat-value">${s['done'] || 0}</span><span class="stat-label">Done</span></div>
                <div class="stat"><span class="stat-value">${s['in-progress'] || 0}</span><span class="stat-label">Active</span></div>
                <div class="stat"><span class="stat-value">${s['blocked'] || 0}</span><span class="stat-label">Blocked</span></div>
            `;
        }

        // Get collapsed columns from localStorage
        function getCollapsedColumns() {
            try {
                return JSON.parse(localStorage.getItem('collapsedColumns') || '[]');
            } catch { return []; }
        }

        function setCollapsedColumns(cols) {
            localStorage.setItem('collapsedColumns', JSON.stringify(cols));
        }

        function updateKanbanGrid() {
            const kanban = document.getElementById('kanban');
            const collapsed = getCollapsedColumns();

            if (collapsed.length > 0) {
                kanban.classList.add('has-collapsed');

                // If ALL columns are collapsed, center them (keep narrow)
                if (collapsed.length === STATUSES.length) {
                    kanban.classList.add('all-collapsed');
                    kanban.style.setProperty('--kanban-grid', 'repeat(4, 52px)');
                } else {
                    kanban.classList.remove('all-collapsed');
                    // Build dynamic grid: 1fr for expanded, 52px for collapsed
                    const gridCols = STATUSES.map(s =>
                        collapsed.includes(s) ? '52px' : '1fr'
                    ).join(' ');
                    kanban.style.setProperty('--kanban-grid', gridCols);
                }
            } else {
                kanban.classList.remove('has-collapsed');
                kanban.classList.remove('all-collapsed');
                kanban.style.removeProperty('--kanban-grid');
            }
        }

        function toggleColumnCollapse(status) {
            const collapsed = getCollapsedColumns();
            const idx = collapsed.indexOf(status);
            if (idx > -1) {
                // Expanding a column
                collapsed.splice(idx, 1);
            } else {
                // Collapsing a column
                collapsed.push(status);

                // If all columns would be collapsed, auto-open In Progress
                if (collapsed.length === STATUSES.length) {
                    const ipIdx = collapsed.indexOf('in-progress');
                    if (ipIdx > -1) {
                        collapsed.splice(ipIdx, 1);
                    }
                }
            }
            setCollapsedColumns(collapsed);

            // Update DOM directly for smooth animation
            STATUSES.forEach(s => {
                const column = document.querySelector(`.column.${s}`);
                if (column) {
                    if (collapsed.includes(s)) {
                        column.classList.add('collapsed');
                    } else {
                        column.classList.remove('collapsed');
                    }
                }
            });

            // Update grid layout
            updateKanbanGrid();
        }

        function renderKanban(nodes) {
            const byStatus = {};
            STATUSES.forEach(s => byStatus[s] = []);
            nodes.forEach(n => {
                if (byStatus[n.status]) byStatus[n.status].push(n);
            });

            const collapsed = getCollapsedColumns();

            document.getElementById('kanban').innerHTML = STATUSES.map((status, colIndex) => `
                <div class="column ${status} ${collapsed.includes(status) ? 'collapsed' : ''}" data-status="${status}">
                    <div class="column-header">
                        <div class="column-header-left">
                            <span class="column-title">${STATUS_LABELS[status]}</span>
                            <span class="column-count">${byStatus[status].length}</span>
                        </div>
                        <button class="collapse-btn" data-status="${status}" title="${collapsed.includes(status) ? 'Expand' : 'Collapse'}" aria-label="${collapsed.includes(status) ? 'Expand' : 'Collapse'} column"></button>
                    </div>
                    <div class="column-cards">
                        ${byStatus[status].length === 0
                            ? '<div class="empty-column">No items</div>'
                            : byStatus[status].map((n, i) => `
                                <div class="card priority-${n.priority}"
                                     data-collection="${n._collection}"
                                     data-id="${n.id}"
                                     style="animation-delay: ${(colIndex * 50) + (i * 30)}ms">
                                    <div class="card-title">${n.title}</div>
                                    <div class="card-meta">
                                        <span class="badge priority-${n.priority}">${n.priority}</span>
                                        ${n.type !== 'feature' ? `<span class="badge type">${n.type}</span>` : ''}
                                        <span class="card-path">${n._collection}/${n.id}</span>
                                    </div>
                                </div>
                            `).join('')}
                    </div>
                </div>
            `).join('');

            // Add card click handlers
            document.querySelectorAll('.card').forEach(card => {
                card.addEventListener('click', () => {
                    openPanel(card.dataset.collection, card.dataset.id);
                });
            });

            // Add collapse button handlers
            document.querySelectorAll('.collapse-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleColumnCollapse(btn.dataset.status);
                    // Update button state
                    const isNowCollapsed = document.querySelector(`.column.${btn.dataset.status}`).classList.contains('collapsed');
                    btn.title = isNowCollapsed ? 'Expand' : 'Collapse';
                    btn.setAttribute('aria-label', isNowCollapsed ? 'Expand column' : 'Collapse column');
                });
            });

            // Add click to expand on collapsed columns
            document.querySelectorAll('.column.collapsed').forEach(col => {
                col.addEventListener('click', (e) => {
                    if (e.target.closest('.collapse-btn')) return;
                    toggleColumnCollapse(col.dataset.status);
                    const btn = col.querySelector('.collapse-btn');
                    if (btn) {
                        btn.title = 'Collapse';
                        btn.setAttribute('aria-label', 'Collapse column');
                    }
                });
            });
        }

        // =====================================================================
        // Panel
        // =====================================================================

        function openPanel(collection, id) {
            const panel = document.getElementById('panel');
            const overlay = document.getElementById('panel-overlay');

            panel.classList.add('open');
            overlay.classList.add('open');

            renderPanelLoading();

            loadNode(collection, id).then(node => {
                currentNode = node;
                currentNode._collection = collection;
                renderPanel(node);
            }).catch(err => {
                renderPanelError(err.message);
            });
        }

        function closePanel() {
            const panel = document.getElementById('panel');
            const overlay = document.getElementById('panel-overlay');
            panel.classList.remove('open');
            overlay.classList.remove('open');
            currentNode = null;
        }

        function renderPanelLoading() {
            document.getElementById('panel-title').textContent = 'Loading...';
            document.getElementById('panel-body').innerHTML = '<div class="loading">Loading...</div>';
            document.getElementById('panel-actions').innerHTML = '';
        }

        function renderPanelError(message) {
            document.getElementById('panel-title').textContent = 'Error';
            document.getElementById('panel-body').innerHTML = `<div class="loading">${message}</div>`;
            document.getElementById('panel-actions').innerHTML = '';
        }

        function renderPanel(node) {
            document.getElementById('panel-title').textContent = node.title;

            let bodyHtml = '';

            // Meta section
            bodyHtml += `
                <div class="panel-section">
                    <h3>Details</h3>
                    <div class="panel-meta">
                        <span class="badge priority-${node.priority}">${node.priority}</span>
                        <span class="badge type">${node.type}</span>
                        <span class="badge">${node.status}</span>
                        ${node.agent_assigned ? `<span class="badge">Agent: ${node.agent_assigned}</span>` : ''}
                    </div>
                </div>
            `;

            // Steps section
            if (node.steps && node.steps.length > 0) {
                const completedCount = node.steps.filter(s => s.completed).length;
                bodyHtml += `
                    <div class="panel-section">
                        <h3>Steps (${completedCount}/${node.steps.length})</h3>
                        <ul class="steps-list">
                            ${node.steps.map((step, i) => `
                                <li class="step-item">
                                    <input type="checkbox" class="step-checkbox"
                                           data-index="${i}"
                                           ${step.completed ? 'checked' : ''}
                                           ${node.status === 'done' ? 'disabled' : ''}>
                                    <div>
                                        <div class="step-text ${step.completed ? 'completed' : ''}">${step.description}</div>
                                        ${step.agent ? `<div class="step-agent">by ${step.agent}</div>` : ''}
                                    </div>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            }

            // Edges section
            const edgeTypes = Object.keys(node.edges || {});
            if (edgeTypes.length > 0) {
                bodyHtml += `<div class="panel-section"><h3>Relationships</h3>`;
                edgeTypes.forEach(edgeType => {
                    const edges = node.edges[edgeType];
                    if (edges && edges.length > 0) {
                        bodyHtml += `
                            <ul class="edge-list">
                                ${edges.map(e => `
                                    <li class="edge-item">
                                        <a data-target="${e.target_id}">${e.title || e.target_id}</a>
                                        <span class="edge-type">${edgeType}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        `;
                    }
                });
                bodyHtml += `</div>`;
            }

            // Content section
            if (node.content) {
                bodyHtml += `
                    <div class="panel-section">
                        <h3>Description</h3>
                        <div class="panel-content">${node.content}</div>
                    </div>
                `;
            }

            // Properties section
            if (node.properties && Object.keys(node.properties).length > 0) {
                bodyHtml += `
                    <div class="panel-section">
                        <h3>Properties</h3>
                        <div class="panel-content">
                            ${Object.entries(node.properties).map(([k, v]) => `<div><strong>${k}:</strong> ${v}</div>`).join('')}
                        </div>
                    </div>
                `;
            }

            // Timestamps
            bodyHtml += `
                <div class="panel-section">
                    <h3>Timestamps</h3>
                    <div class="panel-timestamps">
                        <div>Created: ${new Date(node.created).toLocaleString()}</div>
                        <div>Updated: ${new Date(node.updated).toLocaleString()}</div>
                    </div>
                </div>
            `;

            document.getElementById('panel-body').innerHTML = bodyHtml;

            // Actions
            let actionsHtml = '';

            if (node.type !== 'epic') {
                if (node.status === 'todo') {
                    actionsHtml += `<button class="btn btn-primary" data-action="start">Start</button>`;
                }
                if (node.status === 'in-progress') {
                    actionsHtml += `<button class="btn btn-success" data-action="complete">Done</button>`;
                    actionsHtml += `<button class="btn btn-danger" data-action="block">Block</button>`;
                }
                if (node.status === 'blocked') {
                    actionsHtml += `<button class="btn btn-primary" data-action="unblock">Unblock</button>`;
                }
                if (node.status === 'done') {
                    actionsHtml += `<button class="btn" data-action="reopen">Reopen</button>`;
                }
            }

            document.getElementById('panel-actions').innerHTML = actionsHtml;
            addPanelEventListeners();
        }

        function addPanelEventListeners() {
            // Step checkboxes
            document.querySelectorAll('.step-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', async (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const completed = e.target.checked;

                    if (completed && currentNode) {
                        try {
                            const updated = await updateNode(
                                currentNode._collection,
                                currentNode.id,
                                { complete_step: index, agent: 'user' }
                            );
                            currentNode = { ...updated, _collection: currentNode._collection };
                            renderPanel(currentNode);
                            refreshDashboard();
                        } catch (err) {
                            e.target.checked = !completed;
                            alert('Failed to update step');
                        }
                    }
                });
            });

            // Edge links
            document.querySelectorAll('.edge-item a').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = e.target.dataset.target;
                    const targetNode = allNodes.find(n => n.id === targetId);
                    if (targetNode) {
                        openPanel(targetNode._collection, targetNode.id);
                    }
                });
            });

            // Action buttons
            document.querySelectorAll('[data-action]').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const action = btn.dataset.action;
                    if (!currentNode) return;

                    let update = {};
                    switch (action) {
                        case 'start':
                            update = { status: 'in-progress', agent_assigned: 'user' };
                            break;
                        case 'complete':
                            update = { status: 'done' };
                            break;
                        case 'block':
                            update = { status: 'blocked' };
                            break;
                        case 'unblock':
                            update = { status: 'in-progress' };
                            break;
                        case 'reopen':
                            update = { status: 'todo', agent_assigned: null };
                            break;
                    }

                    try {
                        btn.disabled = true;
                        const updated = await updateNode(currentNode._collection, currentNode.id, update);
                        currentNode = { ...updated, _collection: currentNode._collection };
                        renderPanel(currentNode);
                        refreshDashboard();
                    } catch (err) {
                        alert('Failed to update: ' + err.message);
                    } finally {
                        btn.disabled = false;
                    }
                });
            });
        }

        async function refreshDashboard() {
            const { status, nodes } = await loadData();
            renderStats(status);
            renderKanban(nodes);
            updateKanbanGrid();
        }

        // =====================================================================
        // Graph Visualization
        // =====================================================================

        let simulation = null;

        function getNodeColor(node) {
            const colors = {
                'done': getComputedStyle(document.documentElement).getPropertyValue('--status-done').trim(),
                'in-progress': getComputedStyle(document.documentElement).getPropertyValue('--status-active').trim(),
                'blocked': getComputedStyle(document.documentElement).getPropertyValue('--status-blocked').trim(),
                'todo': getComputedStyle(document.documentElement).getPropertyValue('--status-todo').trim()
            };
            return colors[node.status] || colors['todo'];
        }

        function getNodeRadius(node) {
            const edgeCount = Object.values(node.edges || {})
                .reduce((sum, edges) => sum + edges.length, 0);
            return Math.min(45 + edgeCount * 3, 60);
        }

        function wrapText(text, maxCharsPerLine = 10) {
            const words = text.split(/\s+/);
            const lines = [];
            let currentLine = '';

            for (const word of words) {
                const testLine = currentLine ? currentLine + ' ' + word : word;
                if (testLine.length <= maxCharsPerLine) {
                    currentLine = testLine;
                } else {
                    if (currentLine) lines.push(currentLine);
                    currentLine = word.length > maxCharsPerLine
                        ? word.substring(0, maxCharsPerLine - 1) + ''
                        : word;
                }
            }
            if (currentLine) lines.push(currentLine);

            if (lines.length > 3) {
                lines.length = 3;
                lines[2] = lines[2].substring(0, lines[2].length - 1) + '';
            }

            return lines;
        }

        function buildGraphData(nodes) {
            const graphNodes = nodes.map(n => ({
                id: n.id,
                title: n.title,
                status: n.status,
                type: n.type,
                priority: n.priority,
                edges: n.edges || {},
                _collection: n._collection,
                x: null,
                y: null
            }));

            const nodeIds = new Set(nodes.map(n => n.id));
            const graphEdges = [];

            nodes.forEach(node => {
                Object.entries(node.edges || {}).forEach(([edgeType, edges]) => {
                    edges.forEach(edge => {
                        if (nodeIds.has(edge.target_id)) {
                            graphEdges.push({
                                source: node.id,
                                target: edge.target_id,
                                type: edgeType
                            });
                        }
                    });
                });
            });

            return { nodes: graphNodes, edges: graphEdges };
        }

        function renderGraph(nodes) {
            const svg = document.getElementById('graph-svg');
            const edgesGroup = document.getElementById('graph-edges');
            const nodesGroup = document.getElementById('graph-nodes');

            edgesGroup.innerHTML = '';
            nodesGroup.innerHTML = '';

            if (nodes.length === 0) return;

            const rect = svg.getBoundingClientRect();
            const width = rect.width || 800;
            const height = rect.height || 500;

            const { nodes: graphNodes, edges: graphEdges } = buildGraphData(nodes);
            const nodeById = new Map(graphNodes.map(n => [n.id, n]));

            graphNodes.forEach((n, i) => {
                const angle = (2 * Math.PI * i) / graphNodes.length;
                n.x = width / 2 + Math.cos(angle) * 150;
                n.y = height / 2 + Math.sin(angle) * 150;
            });

            if (simulation) simulation.stop();

            simulation = d3.forceSimulation(graphNodes)
                .force('link', d3.forceLink(graphEdges)
                    .id(d => d.id)
                    .distance(120)
                    .strength(0.5))
                .force('charge', d3.forceManyBody()
                    .strength(-400))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(70))
                .on('tick', updatePositions);

            graphEdges.forEach(edge => {
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.classList.add('graph-edge', edge.type);
                line.setAttribute('marker-end', 'url(#arrowhead)');
                line.dataset.source = edge.source.id || edge.source;
                line.dataset.target = edge.target.id || edge.target;
                edgesGroup.appendChild(line);
            });

            graphNodes.forEach(node => {
                const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                g.classList.add('graph-node');
                g.dataset.id = node.id;
                g.dataset.collection = node._collection;

                const radius = getNodeRadius(node);
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('r', radius);
                circle.setAttribute('fill', getNodeColor(node));

                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                const lines = wrapText(node.title);
                const lineHeight = 11;
                const startY = -((lines.length - 1) * lineHeight) / 2;

                lines.forEach((line, i) => {
                    const tspan = document.createElementNS('http://www.w3.org/2000/svg', 'tspan');
                    tspan.setAttribute('x', '0');
                    tspan.setAttribute('dy', i === 0 ? `${startY}px` : `${lineHeight}px`);
                    tspan.textContent = line;
                    text.appendChild(tspan);
                });

                g.appendChild(circle);
                g.appendChild(text);
                nodesGroup.appendChild(g);

                g.addEventListener('click', () => {
                    openPanel(node._collection, node.id);
                });

                let isDragging = false;
                let dragOffset = { x: 0, y: 0 };

                g.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    dragOffset = { x: e.clientX - node.x, y: e.clientY - node.y };
                    simulation.alphaTarget(0.3).restart();
                    e.preventDefault();
                });

                document.addEventListener('mousemove', (e) => {
                    if (isDragging) {
                        node.fx = e.clientX - dragOffset.x;
                        node.fy = e.clientY - dragOffset.y;
                    }
                });

                document.addEventListener('mouseup', () => {
                    if (isDragging) {
                        isDragging = false;
                        node.fx = null;
                        node.fy = null;
                        simulation.alphaTarget(0);
                    }
                });
            });

            function updatePositions() {
                const nodeElements = nodesGroup.querySelectorAll('.graph-node');
                nodeElements.forEach(g => {
                    const node = nodeById.get(g.dataset.id);
                    if (node) {
                        node.x = Math.max(30, Math.min(width - 30, node.x));
                        node.y = Math.max(30, Math.min(height - 30, node.y));
                        g.setAttribute('transform', `translate(${node.x}, ${node.y})`);
                    }
                });

                const edgeElements = edgesGroup.querySelectorAll('.graph-edge');
                edgeElements.forEach(line => {
                    const source = nodeById.get(line.dataset.source);
                    const target = nodeById.get(line.dataset.target);
                    if (source && target) {
                        line.setAttribute('x1', source.x);
                        line.setAttribute('y1', source.y);
                        line.setAttribute('x2', target.x);
                        line.setAttribute('y2', target.y);
                    }
                });
            }
        }

        // =====================================================================
        // View Toggle
        // =====================================================================

        function switchView(view) {
            const kanban = document.getElementById('kanban');
            const graph = document.getElementById('graph-container');
            const buttons = document.querySelectorAll('.view-btn');

            buttons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });

            if (view === 'kanban') {
                kanban.classList.add('active');
                graph.classList.remove('active');
            } else {
                kanban.classList.remove('active');
                graph.classList.add('active');
                renderGraph(allNodes);
            }
        }

        // =====================================================================
        // Init
        // =====================================================================

        document.getElementById('panel-close').addEventListener('click', closePanel);
        document.getElementById('panel-overlay').addEventListener('click', closePanel);

        document.querySelectorAll('.view-btn').forEach(btn => {
            btn.addEventListener('click', () => switchView(btn.dataset.view));
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closePanel();
        });

        loadData().then(({ status, nodes }) => {
            renderStats(status);
            renderKanban(nodes);
            updateKanbanGrid();
        }).catch(err => {
            document.getElementById('stats').innerHTML = `<div class="loading">Error: ${err.message}</div>`;
        });
    </script>
</body>
</html>
